<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Any-bits Stego</title>
  <style>
    :root {
      --primary-color: #2c3e50;
      --dark-bg: #1e1e1e;
      --light-bg: #f5f5f5;
      --text-color: #333;
    }

    body {
      background-color: var(--dark-bg);
      color: var(--light-bg);
      font-family: sans-serif;
      padding: 2rem;
    }

    h1 {
      color: var(--primary-color);
    }

    label, legend {
      color: var(--light-bg);
      font-weight: bold;
    }

    input[type="file"], input[type="checkbox"] {
      margin: 0.25rem;
    }

    fieldset {
      border: 1px solid var(--primary-color);
      padding: 1rem;
      margin-top: 1rem;
    }

    button {
      background-color: var(--primary-color);
      color: white;
      padding: 0.5rem 1rem;
      margin: 0.5rem 0;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background-color: #34495e;
    }

    a {
      display: inline-block;
      margin-top: 1rem;
      color: var(--primary-color);
    }

    #bitSelector label {
      font-family: monospace;
      display: inline-block;
      width: 3.5em;
    }
  </style>
</head>
<body>
  <h1>Any-bits-you-want Steganography</h1>

  <label>Cover/Stego Image (PNG): <input type="file" id="coverInput" accept="image/png" /></label><br>
  <label>File to Hide: <input type="file" id="fileInput" /></label><br>

  <fieldset>
    <legend>Select Bits to Use</legend>
    <div id="bitSelector"></div>
  </fieldset>

  <button onclick="embedFile()">Embed</button>
  <button onclick="extractFile()">Extract</button>
  <br><br>
  <a id="downloadLink" style="display:none">Download Stego Image</a>
  <a id="extractedLink" style="display:none">Download Extracted File</a>

  <canvas id="canvas" style="display:none"></canvas>

  <script>
    const bitSelector = document.getElementById('bitSelector');
    ['R', 'G', 'B', 'A'].forEach(channel => {
      for (let i = 7; i >= 0; i--) {
        const id = `${channel}${i}`;
        const checkbox = `<label><input type="checkbox" id="${id}" />${id}</label>`;
        bitSelector.innerHTML += checkbox;
      }
      bitSelector.innerHTML += '<br>';
    });

    function toBinaryString(buffer) {
      return Array.from(new Uint8Array(buffer)).map(b => b.toString(2).padStart(8, '0')).join('');
    }

    function binaryToBytes(binStr) {
      const bytes = [];
      for (let i = 0; i < binStr.length; i += 8) {
        bytes.push(parseInt(binStr.slice(i, i + 8), 2));
      }
      return new Uint8Array(bytes);
    }

    async function embedFile() {
      const coverFile = document.getElementById('coverInput').files[0];
      const hiddenFile = document.getElementById('fileInput').files[0];
      if (!coverFile || !hiddenFile) return alert("Please select both files.");

      const coverImg = new Image();
      coverImg.src = URL.createObjectURL(coverFile);
      await coverImg.decode();

      const canvas = document.getElementById('canvas');
      canvas.width = coverImg.width;
      canvas.height = coverImg.height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(coverImg, 0, 0);
      const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imgData.data;

      const hiddenArrayBuffer = await hiddenFile.arrayBuffer();
      const filenameBytes = new TextEncoder().encode(hiddenFile.name + '\0');
      const header = new Uint8Array(5 + filenameBytes.length + 4);
      header.set(new TextEncoder().encode("STEGO"), 0);
      header.set(filenameBytes, 5);
      new DataView(header.buffer).setUint32(5 + filenameBytes.length, hiddenArrayBuffer.byteLength, true);

      const fullData = new Uint8Array([...header, ...new Uint8Array(hiddenArrayBuffer)]);
      const binStr = Array.from(fullData).map(b => b.toString(2).padStart(8, '0')).join('');

      const bitmask = [[], [], [], []];
      ['R', 'G', 'B', 'A'].forEach((ch, i) => {
        for (let b = 7; b >= 0; b--) {
          if (document.getElementById(`${ch}${b}`).checked) bitmask[i].push(b);
        }
      });

      let bitIdx = 0;
      for (let px = 0; px < data.length; px += 4) {
        for (let c = 0; c < 4; c++) {
          bitmask[c].forEach(pos => {
            if (bitIdx >= binStr.length) return;
            const bit = parseInt(binStr[bitIdx]);
            const mask = 1 << pos;
            data[px + c] = (data[px + c] & ~mask) | (bit << pos);
            bitIdx++;
          });
        }
        if (bitIdx >= binStr.length) break;
      }

      if (bitIdx < binStr.length) {
        alert("Cover image is too small for this data and bit depth.");
        return;
      }

      ctx.putImageData(imgData, 0, 0);
      canvas.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        const link = document.getElementById("downloadLink");
        link.href = url;
        link.download = "stego.png";
        link.style.display = "inline";
        link.textContent = "Download Stego Image";
      }, "image/png");
    }

    async function extractFile() {
      const coverFile = document.getElementById('coverInput').files[0];
      if (!coverFile) return alert("Please select a stego image.");

      const coverImg = new Image();
      coverImg.src = URL.createObjectURL(coverFile);
      await coverImg.decode();

      const canvas = document.getElementById('canvas');
      canvas.width = coverImg.width;
      canvas.height = coverImg.height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(coverImg, 0, 0);
      const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

      const bitmask = [[], [], [], []];
      ['R', 'G', 'B', 'A'].forEach((ch, i) => {
        for (let b = 7; b >= 0; b--) {
          if (document.getElementById(`${ch}${b}`).checked) bitmask[i].push(b);
        }
      });

      let binStr = '';
      for (let px = 0; px < data.length; px += 4) {
        for (let c = 0; c < 4; c++) {
          bitmask[c].forEach(pos => {
            const bit = (data[px + c] >> pos) & 1;
            binStr += bit;
          });
        }
      }

      const bytes = binaryToBytes(binStr);
      const startIdx = bytes.findIndex((_, i) =>
        bytes[i] === 83 && bytes[i + 1] === 84 && bytes[i + 2] === 69 && bytes[i + 3] === 71 && bytes[i + 4] === 79);
      if (startIdx === -1) return alert("No STEGO header found.");

      let i = startIdx + 5;
      let end = i;
      while (end < bytes.length && bytes[end] !== 0) end++;
      const filename = new TextDecoder().decode(bytes.slice(i, end));
      const size = new DataView(bytes.buffer).getUint32(end + 1, true);
      const fileBytes = bytes.slice(end + 5, end + 5 + size);

      const blob = new Blob([fileBytes]);
      const url = URL.createObjectURL(blob);
      const link = document.getElementById("extractedLink");
      link.href = url;
      link.download = filename || "output.bin";
      link.style.display = "inline";
      link.textContent = "Download Extracted File";
    }
  </script>
</body>
</html>
